<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>时间管理系统 - 实时同步版</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        /* 移动端优化临时样式 */
        @media (max-width: 768px) {
            .mobile-optimized {
                width: 100% !important;
                overflow-x: auto !important;
            }
        }
        
        /* 网络状态指示器 */
        .network-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(0,0,0,0.7);
            color: white;
            display: none;
        }
        
        .network-status.online {
            background: rgba(46, 204, 113, 0.8);
        }
        
        .network-status.offline {
            background: rgba(231, 76, 60, 0.8);
        }
    </style>
</head>
<body>
    <!-- 网络状态指示器 -->
    <div id="networkStatus" class="network-status">
        <i class="fas fa-wifi"></i> 在线
    </div>

    <!-- 顶部导航 -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-calendar-alt"></i>
                <span>时间管理系统</span>
                <span class="sync-badge" id="syncBadge" style="display:none;">
                    <i class="fas fa-cloud"></i> 实时同步
                </span>
            </div>
            <div class="nav-user" id="navUser">
                <!-- 用户信息动态显示 -->
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container main-container">
        <!-- 系统状态提示 -->
        <div class="alert" id="systemAlert">
            <i class="fas fa-info-circle"></i>
            <span id="alertMessage">访客模式：仅可查看时间安排</span>
            <span id="syncStatusText" style="margin-left: auto; font-size: 12px;"></span>
        </div>

        <!-- 日期选择 -->
        <div class="card date-card">
            <h3><i class="far fa-calendar"></i> 选择日期</h3>
            <div class="date-control">
                <div class="date-input-group">
                    <input type="date" id="datePicker" class="date-input">
                    <div class="quick-actions">
                        <button onclick="goToday()" class="btn btn-primary">
                            <i class="fas fa-calendar-day"></i> 今天
                        </button>
                        <button onclick="changeDate(-1)" class="btn btn-secondary">
                            <i class="fas fa-chevron-left"></i> 前一天
                        </button>
                        <button onclick="changeDate(1)" class="btn btn-secondary">
                            后一天 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="current-date">
                    <span id="currentDateDisplay"></span>
                    <span id="weekDayDisplay"></span>
                </div>
            </div>
        </div>

        <!-- 管理员面板（登录后显示） -->
        <div class="card admin-card" id="adminCard" style="display:none;">
            <div class="admin-header">
                <h3><i class="fas fa-user-cog"></i> 管理员设置</h3>
                <div class="header-actions">
                    <button class="btn btn-sm btn-outline" onclick="openSyncSettings()">
                        <i class="fas fa-sync-alt"></i> 同步设置
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="openAdminSettings()">
                        <i class="fas fa-cog"></i> 管理设置
                    </button>
                </div>
            </div>
            
            <div class="time-setter">
                <h4><i class="far fa-clock"></i> 添加时间段</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>开始时间：</label>
                        <input type="time" id="startTime" class="time-input" step="900">
                    </div>
                    <div class="form-group">
                        <label>结束时间：</label>
                        <input type="time" id="endTime" class="time-input" step="900">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>状态：</label>
                    <div class="status-buttons">
                        <button type="button" class="status-btn status-free active" onclick="selectStatus('free')">
                            空闲
                        </button>
                        <button type="button" class="status-btn status-busy" onclick="selectStatus('busy')">
                            繁忙
                        </button>
                    </div>
                </div>
                
                <button onclick="addSchedule()" class="btn btn-success btn-block">
                    <i class="fas fa-plus"></i> 添加时间段
                </button>
            </div>
            
            <!-- 快捷操作 -->
            <div class="quick-actions-panel">
                <button onclick="exportData()" class="btn btn-outline btn-sm">
                    <i class="fas fa-download"></i> 导出数据
                </button>
                <label class="btn btn-outline btn-sm">
                    <i class="fas fa-upload"></i> 导入数据
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                </label>
                <button onclick="forceSyncNow()" class="btn btn-info btn-sm" id="syncNowBtn">
                    <i class="fas fa-sync"></i> 立即同步
                </button>
            </div>
        </div>

        <!-- 时间表显示 -->
        <div class="card schedule-card">
            <div class="card-header">
                <h3><i class="fas fa-list-alt"></i> 时间安排表</h3>
                <div class="stats-badge">
                    <span class="badge free-badge" id="freeCount">0</span> 空闲
                    <span class="badge busy-badge" id="busyCount">0</span> 繁忙
                    <span class="badge sync-badge" id="onlineCount" title="在线设备数">0</span> 在线
                </div>
            </div>
            
            <div class="table-responsive mobile-optimized">
                <div class="scroll-hint" id="scrollHint" style="display:none;">
                    <i class="fas fa-arrows-alt-h"></i> 左右滑动查看完整表格
                </div>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th class="col-time" data-label="时间段">时间段</th>
                            <th class="col-status" data-label="状态">状态</th>
                            <th class="col-admin" data-label="设置人">设置人</th>
                            <th class="col-actions" data-label="操作">操作</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleTable">
                        <!-- 数据动态加载 -->
                    </tbody>
                </table>
                
                <div class="empty-state" id="emptyState">
                    <i class="far fa-calendar-times"></i>
                    <p>今天没有时间安排</p>
                    <p class="empty-tip">管理员登录后可添加时间安排</p>
                </div>
            </div>
        </div>

        <!-- 说明卡片 -->
        <div class="card help-card">
            <h3><i class="fas fa-question-circle"></i> 使用说明</h3>
            <div class="help-content">
                <div class="help-item">
                    <i class="fas fa-eye"></i>
                    <div>
                        <h4>普通成员</h4>
                        <p>直接查看时间安排，无需登录</p>
                    </div>
                </div>
                <div class="help-item">
                    <i class="fas fa-user-shield"></i>
                    <div>
                        <h4>管理员</h4>
                        <p>点击右上角登录，可设置时间安排</p>
                    </div>
                </div>
                <div class="help-item">
                    <i class="fas fa-sync-alt"></i>
                    <div>
                        <h4>实时同步</h4>
                        <p>• 启用后所有设备实时同步</p>
                        <p>• 支持离线使用</p>
                        <p>• 自动冲突解决</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3><i class="fas fa-sign-in-alt"></i> 管理员登录</h3>
                <button class="close-btn" onclick="hideLoginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loginUsername">
                        <i class="fas fa-user"></i> 管理员账号
                    </label>
                    <input type="text" id="loginUsername" placeholder="输入账号" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">
                        <i class="fas fa-lock"></i> 密码
                    </label>
                    <input type="password" id="loginPassword" placeholder="输入密码" autocomplete="current-password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideLoginModal()">取消</button>
                <button class="btn btn-primary" onclick="performLogin()">
                    <i class="fas fa-sign-in-alt"></i> 登录
                </button>
            </div>
        </div>
    </div>

    <!-- 同步设置模态框 -->
    <div class="modal" id="syncSettingsModal">
        <div class="modal-dialog wide">
            <div class="modal-header">
                <h3><i class="fas fa-sync-alt"></i> 实时同步设置</h3>
                <button class="close-btn" onclick="hideSyncSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 同步状态 -->
                <div class="sync-status-section">
                    <h4><i class="fas fa-cloud"></i> 同步状态</h4>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">网络状态：</span>
                            <span id="syncNetworkStatus" class="status-value online">
                                <i class="fas fa-wifi"></i> 在线
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">同步状态：</span>
                            <span id="syncActiveStatus" class="status-value inactive">
                                <i class="fas fa-pause-circle"></i> 未启用
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">最后同步：</span>
                            <span id="syncLastTime" class="status-value">从未同步</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">在线设备：</span>
                            <span id="syncDeviceCount" class="status-value">1</span>
                        </div>
                    </div>
                </div>

                <!-- 同步控制 -->
                <div class="sync-control-section">
                    <h4><i class="fas fa-cogs"></i> 同步控制</h4>
                    <div class="sync-toggle-group">
                        <div class="toggle-item">
                            <span class="toggle-label">启用实时同步</span>
                            <label class="switch">
                                <input type="checkbox" id="syncToggle" onchange="toggleAutoSync()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">自动冲突解决</span>
                            <label class="switch">
                                <input type="checkbox" id="autoResolveToggle" checked onchange="toggleAutoResolve()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="sync-actions">
                        <button onclick="shareTeamSync()" class="btn btn-primary">
                            <i class="fas fa-share-alt"></i> 分享同步链接
                        </button>
                        <button onclick="forceSyncNow()" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> 立即同步
                        </button>
                        <button onclick="resetSync()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 重置同步
                        </button>
                    </div>
                </div>

                <!-- 同步信息 -->
                <div class="sync-info-section">
                    <h4><i class="fas fa-info-circle"></i> 同步信息</h4>
                    <div class="sync-info">
                        <div class="info-item">
                            <span class="info-label">同步密钥：</span>
                            <code id="syncKeyDisplay" class="sync-key">未生成</code>
                            <button onclick="copySyncKey()" class="btn btn-sm btn-outline">
                                <i class="far fa-copy"></i> 复制
                            </button>
                        </div>
                        <div class="info-item">
                            <span class="info-label">设备ID：</span>
                            <span id="deviceIdDisplay" class="info-value">未知</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">数据版本：</span>
                            <span id="dataVersionDisplay" class="info-value">v1.0</span>
                        </div>
                    </div>
                </div>

                <!-- 云同步设置 -->
                <div class="cloud-sync-section">
                    <h4><i class="fas fa-cloud-upload-alt"></i> 云备份设置</h4>
                    <div class="form-group">
                        <label>GitHub Token（可选）：</label>
                        <input type="password" id="githubToken" placeholder="输入GitHub Token用于云备份" class="form-control">
                        <small class="form-text">
                            <a href="https://github.com/settings/tokens" target="_blank">获取Token</a>
                            （需要gist权限，用于跨浏览器同步）
                        </small>
                    </div>
                    <div class="cloud-actions">
                        <button onclick="setupGitHubSync()" class="btn btn-primary btn-sm">
                            <i class="fas fa-key"></i> 设置Token
                        </button>
                        <button onclick="backupToCloud()" class="btn btn-success btn-sm">
                            <i class="fas fa-cloud-upload-alt"></i> 备份到云端
                        </button>
                        <button onclick="restoreFromCloud()" class="btn btn-info btn-sm">
                            <i class="fas fa-cloud-download-alt"></i> 从云端恢复
                        </button>
                    </div>
                </div>

                <!-- 帮助信息 -->
                <div class="sync-help-section">
                    <h4><i class="fas fa-question-circle"></i> 使用帮助</h4>
                    <div class="help-content">
                        <div class="help-step">
                            <h5><span class="step-number">1</span> 启用同步</h5>
                            <p>开启"启用实时同步"开关，系统会自动生成同步密钥。</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">2</span> 分享链接</h5>
                            <p>点击"分享同步链接"，将生成的链接发送给团队成员。</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">3</span> 加入同步</h5>
                            <p>团队成员打开分享的链接，即可自动加入同步组。</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">4</span> 实时同步</h5>
                            <p>所有设备将自动保持同步，任何修改都会实时更新。</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideSyncSettings()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 管理员设置模态框 -->
    <div class="modal" id="adminSettingsModal">
        <div class="modal-dialog wide">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> 管理员设置</h3>
                <button class="close-btn" onclick="hideAdminSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 当前管理员信息 -->
                <div class="current-admin-info">
                    <h4>当前账号信息</h4>
                    <div class="info-row">
                        <span class="info-label">账号：</span>
                        <span id="currentAccount" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">昵称：</span>
                        <input type="text" id="editAdminName" class="info-input">
                    </div>
                    <button onclick="updateAdminName()" class="btn btn-success btn-sm">
                        <i class="fas fa-save"></i> 更新昵称
                    </button>
                </div>

                <!-- 修改密码 -->
                <div class="change-password-form">
                    <h4>修改密码</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>当前密码：</label>
                            <input type="password" id="currentPassword" placeholder="输入当前密码">
                        </div>
                        <div class="form-group">
                            <label>新密码：</label>
                            <input type="password" id="newPassword" placeholder="输入新密码">
                        </div>
                        <div class="form-group">
                            <label>确认新密码：</label>
                            <input type="password" id="confirmPassword" placeholder="再次输入新密码">
                        </div>
                        <button onclick="changePassword()" class="btn btn-warning">
                            <i class="fas fa-key"></i> 修改密码
                        </button>
                    </div>
                </div>

                <!-- 添加新管理员 -->
                <div class="add-admin-form">
                    <h4>添加新管理员</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>账号：</label>
                            <input type="text" id="newAdminUsername" placeholder="输入账号">
                        </div>
                        <div class="form-group">
                            <label>密码：</label>
                            <input type="password" id="newAdminPassword" placeholder="输入密码">
                        </div>
                        <div class="form-group">
                            <label>昵称：</label>
                            <input type="text" id="newAdminName" placeholder="输入昵称">
                        </div>
                        <button onclick="addNewAdmin()" class="btn btn-success">
                            <i class="fas fa-plus"></i> 添加
                        </button>
                    </div>
                </div>

                <!-- 现有管理员列表 -->
                <div class="admin-list">
                    <h4>管理员列表</h4>
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>账号</th>
                                    <th>昵称</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminList">
                                <!-- 管理员列表动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAdminSettings()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 冲突解决模态框 -->
    <div class="modal" id="conflictModal" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle text-warning"></i> 数据冲突</h3>
                <button class="close-btn" onclick="hideConflictModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>发现数据冲突，请选择如何处理：</p>
                <div class="conflict-options">
                    <div class="conflict-option">
                        <input type="radio" id="resolveKeepLocal" name="resolveOption" value="local" checked>
                        <label for="resolveKeepLocal">
                            <strong>保留本地数据</strong>
                            <small>丢弃云端更改，使用本地版本</small>
                        </label>
                    </div>
                    <div class="conflict-option">
                        <input type="radio" id="resolveKeepCloud" name="resolveOption" value="cloud">
                        <label for="resolveKeepCloud">
                            <strong>使用云端数据</strong>
                            <small>覆盖本地更改，使用云端版本</small>
                        </label>
                    </div>
                    <div class="conflict-option">
                        <input type="radio" id="resolveMerge" name="resolveOption" value="merge">
                        <label for="resolveMerge">
                            <strong>智能合并</strong>
                            <small>自动合并冲突，保留最新更改</small>
                        </label>
                    </div>
                </div>
                <div class="conflict-preview">
                    <h5>冲突预览：</h5>
                    <div id="conflictPreview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideConflictModal()">取消</button>
                <button class="btn btn-primary" onclick="resolveConflict()">确定</button>
            </div>
        </div>
    </div>

    <!-- 脚注 -->
    <footer class="footer">
        <div class="container">
            <p>时间管理系统 v2.0 &copy; 2024 | 实时同步版 | <span id="footerSyncStatus">同步已禁用</span></p>
        </div>
    </footer>

    <!-- 同步指示器 -->
    <div id="syncIndicator" class="sync-indicator" title="点击手动同步" onclick="forceSyncNow()">
        <i class="fas fa-cloud-slash"></i>
    </div>

    <!-- 脚本引入 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="script.js"></script>
</body>
</html>