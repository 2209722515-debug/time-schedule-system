<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>时间管理系统 - GitHub云同步版</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        /* 移动端优化临时样式 */
        @media (max-width: 768px) {
            .mobile-optimized {
                width: 100% !important;
                overflow-x: auto !important;
            }
        }
        
        /* 网络状态指示器 */
        .network-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(0,0,0,0.7);
            color: white;
            display: none;
        }
        
        .network-status.online {
            background: rgba(46, 204, 113, 0.8);
        }
        
        .network-status.offline {
            background: rgba(231, 76, 60, 0.8);
        }

        /* GitHub配置提示 */
        .github-config-alert {
            background: linear-gradient(135deg, #24292e 0%, #24292e 100%);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .github-config-alert a {
            color: #58a6ff;
            text-decoration: none;
            font-weight: bold;
        }
        
        .github-config-alert a:hover {
            text-decoration: underline;
        }
        
        /* Token状态指示器 */
        .token-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .token-status-ok {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .token-status-none {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }
        
        .token-status-error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- 网络状态指示器 -->
    <div id="networkStatus" class="network-status">
        <i class="fas fa-wifi"></i> 在线
    </div>

    <!-- 顶部导航 -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-calendar-alt"></i>
                <span>时间管理系统</span>
                <span class="sync-badge" id="syncBadge" style="display:none;">
                    <i class="fab fa-github"></i> 云同步
                </span>
                <!-- Token状态指示器 -->
                <span id="tokenStatusIndicator" class="token-status-indicator token-status-none">
                    <i class="fas fa-key"></i> 未配置Token
                </span>
            </div>
            <div class="nav-user" id="navUser">
                <!-- 用户信息动态显示 -->
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container main-container">
        <!-- GitHub配置提示 -->
        <div class="github-config-alert" id="githubConfigAlert">
            <i class="fab fa-github"></i>
            <span>云同步已启用：数据存储在 <a href="https://github.com/2209722515-debug/time-schedule-data" target="_blank">GitHub Repository</a>，跨设备实时同步</span>
            <button onclick="openSyncSettings()" class="btn btn-sm btn-outline" style="color: white; border-color: white; margin-left: auto;">
                <i class="fas fa-cog"></i> 同步设置
            </button>
        </div>

        <!-- 系统状态提示 -->
        <div class="alert" id="systemAlert">
            <i class="fas fa-info-circle"></i>
            <span id="alertMessage">访客模式：仅可查看时间安排</span>
            <span id="syncStatusText" style="margin-left: auto; font-size: 12px;"></span>
        </div>

        <!-- 日期选择 -->
        <div class="card date-card">
            <h3><i class="far fa-calendar"></i> 选择日期</h3>
            <div class="date-control">
                <div class="date-input-group">
                    <input type="date" id="datePicker" class="date-input">
                    <div class="quick-actions">
                        <button onclick="goToday()" class="btn btn-primary">
                            <i class="fas fa-calendar-day"></i> 今天
                        </button>
                        <button onclick="changeDate(-1)" class="btn btn-secondary">
                            <i class="fas fa-chevron-left"></i> 前一天
                        </button>
                        <button onclick="changeDate(1)" class="btn btn-secondary">
                            后一天 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="current-date">
                    <span id="currentDateDisplay"></span>
                    <span id="weekDayDisplay"></span>
                </div>
            </div>
        </div>

        <!-- 管理员面板（登录后显示） -->
        <div class="card admin-card" id="adminCard" style="display:none;">
            <div class="admin-header">
                <h3><i class="fas fa-user-cog"></i> 管理员设置</h3>
                <div class="header-actions">
                    <button class="btn btn-sm btn-outline" onclick="openSyncSettings()">
                        <i class="fas fa-sync-alt"></i> 同步设置
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="openAdminSettings()">
                        <i class="fas fa-cog"></i> 管理设置
                    </button>
                    <button class="btn btn-sm btn-success" onclick="configureGitHubToken()" id="configureTokenBtn">
                        <i class="fas fa-key"></i> 配置GitHub Token
                    </button>
                </div>
            </div>
            
            <div class="time-setter">
                <h4><i class="far fa-clock"></i> 添加时间段</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>开始时间：</label>
                        <input type="time" id="startTime" class="time-input" step="900">
                    </div>
                    <div class="form-group">
                        <label>结束时间：</label>
                        <input type="time" id="endTime" class="time-input" step="900">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>状态：</label>
                    <div class="status-buttons">
                        <button type="button" class="status-btn status-free active" onclick="selectStatus('free')">
                            空闲
                        </button>
                        <button type="button" class="status-btn status-busy" onclick="selectStatus('busy')">
                            繁忙
                        </button>
                    </div>
                </div>
                
                <button onclick="addSchedule()" class="btn btn-success btn-block">
                    <i class="fas fa-plus"></i> 添加时间段
                </button>
            </div>
            
            <!-- 快捷操作 -->
            <div class="quick-actions-panel">
                <button onclick="exportData()" class="btn btn-outline btn-sm">
                    <i class="fas fa-download"></i> 导出数据
                </button>
                <label class="btn btn-outline btn-sm">
                    <i class="fas fa-upload"></i> 导入数据
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                </label>
                <button onclick="forceSyncNow()" class="btn btn-info btn-sm" id="syncNowBtn">
                    <i class="fas fa-sync"></i> 立即同步
                </button>
                <button onclick="uploadToGitHubNow()" class="btn btn-success btn-sm" id="uploadNowBtn">
                    <i class="fab fa-github"></i> 上传到GitHub
                </button>
            </div>
        </div>

        <!-- 时间表显示 -->
        <div class="card schedule-card">
            <div class="card-header">
                <h3><i class="fas fa-list-alt"></i> 时间安排表</h3>
                <div class="stats-badge">
                    <span class="badge free-badge" id="freeCount">0</span> 空闲
                    <span class="badge busy-badge" id="busyCount">0</span> 繁忙
                    <span class="badge sync-badge" id="lastSyncTimeBadge" title="最后同步时间">刚刚</span>
                </div>
            </div>
            
            <div class="table-responsive mobile-optimized">
                <div class="scroll-hint" id="scrollHint" style="display:none;">
                    <i class="fas fa-arrows-alt-h"></i> 左右滑动查看完整表格
                </div>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th class="col-time" data-label="时间段">时间段</th>
                            <th class="col-status" data-label="状态">状态</th>
                            <th class="col-admin" data-label="设置人">设置人</th>
                            <th class="col-actions" data-label="操作">操作</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleTable">
                        <!-- 数据动态加载 -->
                    </tbody>
                </table>
                
                <div class="empty-state" id="emptyState">
                    <i class="far fa-calendar-times"></i>
                    <p>今天没有时间安排</p>
                    <p class="empty-tip">管理员登录后可添加时间安排</p>
                </div>
            </div>
        </div>

        <!-- 说明卡片 -->
      <div class="card help-card">
    <h3><i class="fas fa-question-circle"></i> 使用说明</h3>
    <div class="help-content">
        <div class="help-item">
            <i class="fas fa-eye"></i>
            <div>
                <h4>普通成员</h4>
                <p>直接查看时间安排，数据来自GitHub云端</p>
            </div>
        </div>
        <div class="help-item">
            <i class="fas fa-user-shield"></i>
            <div>
                <h4>管理员</h4>
                <p>登录后可修改时间安排，保存到云端</p>
                <p><strong>所有管理员</strong>都可以配置和使用GitHub Token</p>
            </div>
        </div>
        <div class="help-item">
            <i class="fab fa-github"></i>
            <div>
                <h4>GitHub云同步</h4>
                <p>• 数据存储在GitHub仓库</p>
                <p>• 所有管理员都可上传修改</p>
                <p>• 实时同步更新</p>
                <p>• 支持多设备访问</p>
            </div>
        </div>
    </div>
</div>

    <!-- 登录模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3><i class="fas fa-sign-in-alt"></i> 管理员登录</h3>
                <button class="close-btn" onclick="hideLoginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loginUsername">
                        <i class="fas fa-user"></i> 管理员账号
                    </label>
                    <input type="text" id="loginUsername" placeholder="输入账号" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">
                        <i class="fas fa-lock"></i> 密码
                    </label>
                    <input type="password" id="loginPassword" placeholder="输入密码" autocomplete="current-password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideLoginModal()">取消</button>
                <button class="btn btn-primary" onclick="performLogin()">
                    <i class="fas fa-sign-in-alt"></i> 登录
                </button>
            </div>
        </div>
    </div>

    <!-- 同步设置模态框 -->
    <div class="modal" id="syncSettingsModal">
        <div class="modal-dialog wide">
            <div class="modal-header">
                <h3><i class="fas fa-sync-alt"></i> GitHub云同步设置</h3>
                <button class="close-btn" onclick="hideSyncSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 同步状态 -->
                <div class="sync-status-section">
                    <h4><i class="fab fa-github"></i> GitHub同步状态</h4>
                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">网络状态：</span>
                            <span id="syncNetworkStatus" class="status-value online">
                                <i class="fas fa-wifi"></i> 在线
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">同步状态：</span>
                            <span id="syncActiveStatus" class="status-value inactive">
                                <i class="fas fa-sync-alt"></i> 自动同步
                            </span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">最后同步：</span>
                            <span id="syncLastTime" class="status-value">从未同步</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Token状态：</span>
                            <span id="githubTokenStatus" class="status-value warning">
                                <i class="fas fa-exclamation-circle"></i> 未配置
                            </span>
                        </div>
                    </div>
                </div>

                <!-- GitHub Token配置 -->
                <div class="sync-control-section">
                    <h4><i class="fas fa-key"></i> GitHub Token配置</h4>
                    <div class="form-group">
                        <label>当前GitHub Token：</label>
                        <div class="input-group">
                            <input type="password" id="currentTokenDisplay" 
                                   class="form-control" 
                                   placeholder="未配置Token" 
                                   readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline" type="button" onclick="toggleTokenVisibility()">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <small class="form-text">
                            Token存储在浏览器本地，<strong>所有管理员共享使用</strong>
                        </small>
                    </div>
                    
                    <div class="sync-actions">
                        <button onclick="configureGitHubToken()" class="btn btn-primary">
                            <i class="fas fa-key"></i> 配置/更新Token
                        </button>
                        <button onclick="testGitHubToken()" class="btn btn-success">
                            <i class="fas fa-vial"></i> 测试Token
                        </button>
                        <button onclick="removeGitHubToken()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 移除Token
                        </button>
                    </div>
                </div>

                <!-- 同步控制 -->
                <div class="sync-control-section">
                    <h4><i class="fas fa-cogs"></i> 同步控制</h4>
                    <div class="sync-toggle-group">
                        <div class="toggle-item">
                            <span class="toggle-label">启用实时同步</span>
                            <label class="switch">
                                <input type="checkbox" id="syncToggle" checked onchange="toggleAutoSync()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">自动冲突解决</span>
                            <label class="switch">
                                <input type="checkbox" id="autoResolveToggle" checked onchange="toggleAutoResolve()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">自动上传修改</span>
                            <label class="switch">
                                <input type="checkbox" id="autoUploadToggle" checked onchange="toggleAutoUpload()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="sync-actions">
                        <button onclick="forceSyncNow()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> 立即同步
                        </button>
                        <button onclick="uploadToGitHubNow()" class="btn btn-success">
                            <i class="fab fa-github"></i> 手动上传到GitHub
                        </button>
                        <button onclick="resetLocalData()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 清空本地数据
                        </button>
                    </div>
                </div>

                <!-- GitHub配置信息 -->
                <div class="sync-info-section">
                    <h4><i class="fab fa-github"></i> GitHub配置信息</h4>
                    <div class="sync-info">
                        <div class="info-item">
                            <span class="info-label">仓库地址：</span>
                            <code class="sync-key">
                                <a href="https://github.com/2209722515-debug/time-schedule-data" target="_blank" style="color: inherit;">
                                    https://github.com/2209722515-debug/time-schedule-data
                                </a>
                            </code>
                        </div>
                        <div class="info-item">
                            <span class="info-label">数据文件：</span>
                            <span class="info-value">data.json</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">数据版本：</span>
                            <span id="dataVersionDisplay" class="info-value">v1.0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">本地方案：</span>
                            <span id="localScheduleCount" class="info-value">0 条</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">云端方案：</span>
                            <span id="cloudScheduleCount" class="info-value">0 条</span>
                        </div>
                    </div>
                </div>

                <!-- 使用帮助 -->
                <div class="sync-help-section">
                    <h4><i class="fas fa-question-circle"></i> 使用帮助</h4>
                    <div class="help-content">
                        <div class="help-step">
                            <h5><span class="step-number">1</span> 配置GitHub Token</h5>
                            <p>任何管理员都可以配置Token，配置后所有管理员共享使用</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">2</span> 获取Token</h5>
                            <p>访问 <a href="https://github.com/settings/tokens" target="_blank">GitHub Token设置</a>，生成有 <code>repo</code> 权限的Token</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">3</span> 数据同步</h5>
                            <p>配置Token后，所有管理员都可以上传和同步数据</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">4</span> 权限说明</h5>
                            <p>所有管理员权限平等，都可以配置Token和管理数据</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideSyncSettings()">关闭</button>
            </div>
        </div>
    </div>

    <!-- GitHub Token配置模态框 -->
    <div class="modal" id="githubTokenModal">
        <div class="modal-dialog wide">
            <div class="modal-header">
                <h3><i class="fab fa-github"></i> 配置GitHub Token</h3>
                <button class="close-btn" onclick="hideGitHubTokenModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Token输入 -->
                <div class="form-group">
                    <label for="githubTokenInput">
                        <i class="fas fa-key"></i> GitHub Personal Access Token
                    </label>
                    <input type="password" id="githubTokenInput" 
                           placeholder="输入你的GitHub Token" 
                           class="form-control">
                    <small class="form-text">
                        所有管理员共享使用此Token进行数据上传
                    </small>
                </div>
                
                <!-- 获取Token指导 -->
                <div class="sync-help-section">
                    <h4><i class="fas fa-graduation-cap"></i> 如何获取GitHub Token</h4>
                    <div class="help-content">
                        <div class="help-step">
                            <h5><span class="step-number">1</span> 访问Token设置</h5>
                            <p>打开 <a href="https://github.com/settings/tokens" target="_blank">GitHub Token设置页面</a></p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">2</span> 生成新Token</h5>
                            <p>点击 "Generate new token" → "Generate new token (classic)"</p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">3</span> 配置Token</h5>
                            <p>
                                • <strong>名称</strong>: Time Schedule Sync<br>
                                • <strong>过期时间</strong>: 选择 "No expiration"<br>
                                • <strong>权限</strong>: 必须勾选 <code>repo</code> (完整仓库权限)
                            </p>
                        </div>
                        <div class="help-step">
                            <h5><span class="step-number">4</span> 生成并复制</h5>
                            <p>点击 "Generate token"，<strong>立即复制生成的Token</strong>（只显示一次）</p>
                        </div>
                    </div>
                </div>
                
                <!-- 权限说明 -->
                <div class="sync-info-section">
                    <h4><i class="fas fa-shield-alt"></i> 权限说明</h4>
                    <div class="alert" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>
                            <strong>注意：</strong>此Token将被所有管理员共享使用。请确保：
                            <ul style="margin: 5px 0 0 20px;">
                                <li>只添加可信的管理员</li>
                                <li>Token需要 <code>repo</code> 权限才能上传数据</li>
                                <li>如果Token泄露，请立即在GitHub上撤销</li>
                            </ul>
                        </span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideGitHubTokenModal()">取消</button>
        <button class="btn btn-success" onclick="testGitHubTokenInput()" id="testTokenBtn">
            <i class="fas fa-vial"></i> 测试Token
        </button>
        <button class="btn btn-primary" onclick="saveGitHubToken()" id="saveTokenBtn">
            <i class="fas fa-save"></i> 保存Token
        </button>
    </div>
</div>

    <!-- 管理员设置模态框 -->
    <div class="modal" id="adminSettingsModal">
        <div class="modal-dialog wide">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> 管理员设置</h3>
                <button class="close-btn" onclick="hideAdminSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 当前管理员信息 -->
                <div class="current-admin-info">
                    <h4>当前账号信息</h4>
                    <div class="info-row">
                        <span class="info-label">账号：</span>
                        <span id="currentAccount" class="info-value"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">昵称：</span>
                        <input type="text" id="editAdminName" class="info-input">
                    </div>
                    <button onclick="updateAdminName()" class="btn btn-success btn-sm">
                        <i class="fas fa-save"></i> 更新昵称
                    </button>
                </div>

                <!-- 修改密码 -->
                <div class="change-password-form">
                    <h4>修改密码</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>当前密码：</label>
                            <input type="password" id="currentPassword" placeholder="输入当前密码">
                        </div>
                        <div class="form-group">
                            <label>新密码：</label>
                            <input type="password" id="newPassword" placeholder="输入新密码">
                        </div>
                        <div class="form-group">
                            <label>确认新密码：</label>
                            <input type="password" id="confirmPassword" placeholder="再次输入新密码">
                        </div>
                        <button onclick="changePassword()" class="btn btn-warning">
                            <i class="fas fa-key"></i> 修改密码
                        </button>
                    </div>
                </div>

                <!-- 添加新管理员 -->
                <div class="add-admin-form">
                    <h4>添加新管理员</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>账号：</label>
                            <input type="text" id="newAdminUsername" placeholder="输入账号">
                        </div>
                        <div class="form-group">
                            <label>密码：</label>
                            <input type="password" id="newAdminPassword" placeholder="输入密码">
                        </div>
                        <div class="form-group">
                            <label>昵称：</label>
                            <input type="text" id="newAdminName" placeholder="输入昵称">
                        </div>
                        <button onclick="addNewAdmin()" class="btn btn-success">
                            <i class="fas fa-plus"></i> 添加
                        </button>
                    </div>
                </div>

                <!-- 现有管理员列表 -->
                <div class="admin-list">
                    <h4>管理员列表</h4>
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>账号</th>
                                    <th>昵称</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminList">
                                <!-- 管理员列表动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAdminSettings()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 脚注 -->
    <footer class="footer">
        <div class="container">
            <p>时间管理系统 v2.0 &copy; 2024 | GitHub云同步版 | 数据仓库：<a href="https://github.com/2209722515-debug/time-schedule-data" target="_blank" style="color: #58a6ff;">2209722515-debug/time-schedule-data</a></p>
            <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> 所有管理员均可配置GitHub Token进行数据上传
            </p>
        </div>
    </footer>

    <!-- 同步指示器 -->
    <div id="syncIndicator" class="sync-indicator" title="点击手动同步" onclick="forceSyncNow()">
        <i class="fab fa-github"></i>
    </div>

    <!-- 脚本引入 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="script.js"></script>
</body>
</html>